<!-- 技書博のパンフレット向け記事です。大技林の本編には取り込まない。 -->

<!-- 
タイトル：
ゆめみの執筆環境を支える技術

著者：
横田孝次郎、江本光晴
-->

# ゆめみの執筆環境を支える技術

## はじめに

ゆめみ大技林製作委員会は、株式会社ゆめみの有志メンバーによる技術同人誌サークルです。2022 年に活動を開始して以来、技術同人誌「ゆめみ大技林」の製作と頒布を行なってきました。我々の活動は、主に社内向けに行なっています。一方で、社内外を含めて、もっと多くの人が気軽に執筆して欲しいと考えています。

## 執筆テンプレートの紹介

本の製作は、原稿を書くだけではありません。その他にも多くの工程があります。たとえば、次のような作業があります。これらが障害となり、執筆に踏み出せない方がいると感じました。

- テキストや画像を紙面向けにページ配置する組版作業を行う
- フォントのアウトライン化や裁断用トンボの追加など、印刷所への入稿データを作成する

そこで、弊誌の製作に利用している執筆テンプレートを公開しました。執筆テンプレートは GitHub で Template Repository として管理しています。次の URL から、あなたの執筆プロジェクトを作成できます。

```url
https://github.com/yumemi-inc/daigirin-template
```

![執筆テンプレートの GitHub URL](./images_gishohaku/qr-code-daigirin-template-url.png)

このテンプレートは、Markdown ファイルで執筆します。そして、その執筆した原稿から電子書籍および印刷所の入稿用 PDF を製作します。本の製作工程において、執筆から印刷所に入稿する手前までの作業をサポートします。あなたは原稿を書くことだけに専念できます。なお、表紙作成は含まれていません。

テンプレートでは、CSS 組版に対応したオープンソースソフトウェア Vivliostyle [^vivliostyle] を採用しています。Web の標準技術を利用しているので、Web 関連の開発経験があれば、すぐに扱えます。組版のカスタマイズも容易です。

[^vivliostyle]: Vivliostyle, https://vivliostyle.org/ja/

テンプレートはご自由にご利用いただけます。もし改善点やご提案があれば、ぜひ GitHub から issue や pull request をお送りください。一緒に、よりよい執筆環境を作っていきましょう。

## テンプレートの工夫

執筆テンプレートは最初からすべてが揃っていたわけではありません。サークルメンバーが集まり、テンプレートの改善を日々行なっています。

### テーマ

ゆめみ大技林のテーマは、「Vivliostyle Theme Macneko Techbook[^theme]」をベースに若干カスタマイズを行ったものを利用しています。 本テーマはゆめみ大技林製作委員会のメンバーが自作したもので、 Vivliostyle 公式テーマの Techbook[^techbook] をベースに組版設計の気になった部分に対してカスタマイズを行っています。

[^theme]: https://www.npmjs.com/package/vivliostyle-theme-macneko-techbook
[^techbook]: https://github.com/vivliostyle/themes/tree/main/packages/%40vivliostyle/theme-techbook

本テーマのコンセプトは、Vivliostyle の公式テーマから大きく改変せず、公式テーマの新バージョンリリースをなるべく早く取り込んで、執筆体験をよくすることです。

本テーマで行っているカスタマイズの一部を紹介します。

#### 見出しをなるべく追い込むように調整する

公式テーマでは、見出しをなるべく次のページに送り込むように定義されています。この状態で既刊の記事を流し込んで確認したところ、見出しが登場した際に改ページが行われることで本文がページの半分ほどしかないページが続いたり、改ページによるページ数増加が発生したりしました。  
本文がページの半分ほどしかないページが続いた際の読みづらさや、ページ数増加による印刷代増加を避けるため、見出しをなるべく前のページに追い込むように調整しました。

```css
:root {
  /* 
   * header page break
   */
  --vs-section--h1-break-before: inherit;
  --vs-section--h2-break-before: auto;
  --vs-section--h3-break-before: auto;
  --vs-section--h4-break-before: auto;
  --vs-section--h5-break-before: auto;
  --vs-section--h6-break-before: auto;
}
```

#### コードブロックを調整する

公式テーマでは、コードブロックがページをまたいだ際に網掛け内の天地のマージンが一定ではなく読みづらさを感じたので、マージンが一定になるように調整し、あわせて文字サイズや行間も調整しました。

解決できていない問題として、「`display: flex` とした場合、キャプション付きのコードブロックに対して 1 ページ内に収まらない分量の長いコードを挿入すると、コードブロックがページ下部を突き抜けてしまう」というものがあり、キャプションありの場合は `display: block` にすることで回避しています。

```css
:root {
  /* 
   * code block
   */
  /* 等幅フォントの行間 */
  --vs--monospace-line-height: 1.3;
  /* コードブロック関連の文字サイズ */
  --vs--pre-font-size: 95%;
}

/* 
 * code block
 */
@media print {
  pre[class*='language-'] {
    /* コードブロックが複数ページにまたがったときに別ボックスとすることで、天地のマージンを一定にする */
    box-decoration-break: clone;
  }
}

figure[class*='language-'] {
  /* 
   * キャプション付きのコードブロックに対して1ページ内に収まらない分量の長いコードを挿入すると、
   * コードブロックがページ下部を突き抜けてしまうので、
   * キャプションありの場合は flex にしない
   */
  display: block;
}
```

#### URLに対して自動で生成される脚注表記を無効化する

脚注とは、本文の下部に表示される注記のことを指します

公式テーマでは、URL に対して自動で脚注表記が生成されるのですが、著者自身で表記の有無をコントロールするほうが扱いやすいと感じたため、次のように調整して無効化しました。

```css
/* 
 * footnote-external-link
 */
@media print {
  /* URL に対して自動生成された脚注表記を非表示にする */
  :not(.footnote) > a[href^='http']::before {
    display: none;
  }

  :not(.footnote) > a[href^='http']::after {
  /* URL の後ろに付与された脚注番号を非表示にする */
    display: none;
  }
}
```

他にもカスタマイズを行っている部分はあるのですが、紙面の都合もあり割愛します。「新しくなった Vivliostyle Themes のカスタムテーマを公開する[^article]」という記事でカスタマイズ事例の紹介はもちろん、npm パッケージとして公開する方法なども掲載していますので、興味をもっていただいた方はご覧いただけるとうれしいです（2023 年の記事ですが基本的な部分はそのまま活用できると思います）。また、公開しているテーマのリポジトリからソースコードも確認できますので、あわせてご覧ください。

[^article]: https://zenn.dev/macneko/articles/e08dcfaef8e6b0

### レビューコストの削減

我々は商業誌ではなく同人活動の一貫でもあるので、個人の書き味を尊重しています。厳密な原稿チェックはしていません。しかし、Pull Request を用いて、次のような最低限のレビューをしています。

- 誤字脱字
- 文章の意図や意味が伝わりづらいところはないか
- 電子版と紙版で情報落ちがないか
- 社外秘の情報が含まれていないか

そのような目的で、記事追加の PR が作られています。また、depandabot による依存ライブラリを更新するメンテナンス用の PR も作れています。

これまでは変更内容を確認して、手元でビルドして PDF を確認していました。しかし、執筆の佳境に入ると、同時期に多くの PR が作られ、レビューコストもあがります。また執筆期間でもなくても、メンテナンス目的の PR は日々作られます。通常業務の忙しさから放置することもありました。そこでレビューコストの削減に取り組みました。

#### GitHub Actions による PDF の自動生成

通常の開発業務では PR が作れると CI が動き、テストやビルドの確認が自動で行なわれてるのが一般的です。執筆という特殊な対象だったので、CI はいる？と躊躇してましたが、やっぱり必要と判断して作成しました。

現在、PR を作成すると、GitHub Actions で PDF が生成され、それがコメントで添付されます。これまで、ローカルでビルドしていた作業は不要になりました。レビューは執筆内容の確認、PDF の組版に問題はないかの目視だけになり、作業量は下がりました。

#### フォント設定のテーマを作成

Vivliostyle は、設定したテーマにもよりますが、PDF のフォントはローカルにあるフォントが利用されます。同じ内容の執筆プロジェクトでもビルド環境によってフォントが異なります。

この問題がもっとも影響を与えるのは、前述の GitHub Actions で PDF を生成したときです。GitHub Actions の実行環境に日本語フォントがなく、文字がいわゆる豆腐になってしまった。

問題解決するため、当初はプロジェクトにフォントを埋め込みました。しかし、新規プロジェクトを作成するごとに、その設定をするのは大変です。そこで、フォント設定するだけのテーマを作成しました。

```url
https://github.com/mitsuharu/vivliostyle-theme-noto-sans-jp
```

このフォント設定のテーマは次のように設定します。どのテーマでもフォントは Noto Sans に固定されます。

```javascript
module.exports = {
  theme: [
    '@vivliostyle/theme-techbook',
    '@mitsuharu/vivliostyle-theme-noto-sans-jp',
  ],
};
```

このテーマは一般にも公開しています。同様にフォントの問題に悩まされている方は、ご利用ください。

## まとめ

ゆめみの執筆環境は日々改善しています。今回紹介した内容の他にも、自動化を進めています。我々は「記事を書く」「表紙画像を描く」以外は自動化できるようにテンプレートを改良しています。最近は AI による校正支援も対応しました。ぜひ、みなさんも執筆テンプレートをご利用してください。
